<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>pixelmyqube</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <!-- 
      v1.9: Consolidated all three.js scripts to use the same CDN (cdnjs)
      to prevent loading conflicts between different CDNs.
    -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/examples/js/loaders/OBJLoader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/examples/js/exporters/3MFExporter.js"></script>

    <!-- Load external stylesheet -->
    <link rel="stylesheet" href="assets/style.css">
</head>
<body class="bg-black font-sans flex flex-col items-center justify-center min-h-screen p-4">

    <div class="bg-white shadow-xl rounded-lg p-6 w-full max-w-4xl">
        
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">PixelmyQube</h1>
        
        <div class="flex flex-col lg:flex-row gap-6">

            <!-- Left Panel: Controls & Stats -->
            <div class="flex-shrink-0 lg:w-1/3">
                <div class="bg-gray-50 p-4 rounded-lg shadow-inner">
                    <h2 class="text-xl font-semibold mb-4 text-gray-700">Controls</h2>

                    <!-- Color Palette -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-600 mb-2">Color</label>
                        <div id="color-palette" class="flex flex-wrap gap-3 items-center">
                            <!-- Eraser -->
                            <div class="color-swatch active" data-color="null" style="background-color: #f0f0f0; background-image: url('data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2224%22 height=%2224%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22currentColor%22 stroke-width=%222%22 stroke-linecap=%22round%22 stroke-linejoin=%22round%22 class=%22feather feather-delete%22><path d=%22M21 4H8l-7 8 7 8h13a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z%22></path><line x1=%2218%22 y1=%229%22 x2=%2212%22 y2=%2215%22></line><line x1=%2212%22 y1=%229%22 x2=%2218%22 y2=%2215%22></line></svg>'); background-size: 60%; background-position: center; background-repeat: no-repeat;" title="Eraser"></div>
                            <!-- Colors -->
                            <div class="color-swatch" data-color="#E53E3E" style="background-color: #E53E3E" title="Red"></div>
                            <div class="color-swatch" data-color="#38A169" style="background-color: #38A169" title="Green"></div>
                            <div class="color-swatch" data-color="#3182CE" style="background-color: #3182CE" title="Blue"></div>
                            <div class="color-swatch" data-color="#FC6D09" style="background-color: #FC6D09" title="Orange"></div>
                            <div class="color-swatch" data-color="#FFFFFF" style="background-color: #FFFFFF; border: 1px solid #ddd;" title="White"></div>
                            
                            <input type="color" id="color-picker" class="w-10 h-10 p-0 border-none cursor-pointer rounded-full" value="#FF0000">
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex flex-col gap-3 mt-6">
                        <button id="clear-btn" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                            Clear Grid
                        </button>
                        <button id="download-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors" disabled>
                            Loading model...
                        </button>
                    </div>

                    <!-- Statistics -->
                    <div id="stats-container" class="mt-6">
                        <h3 class="text-lg font-semibold text-gray-700">Statistics</h3>
                        <div class="bg-white p-3 rounded mt-2">
                            <p id="pixel-count-total" class="text-sm text-gray-600">Total: 0 pixels</p>
                            <div id="pixel-count-colors" class="mt-2 text-sm">
                                <!-- Stats generated by JS -->
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- Right Panel: Grid -->
            <div class="flex-grow flex items-center justify-center">
                <div id="grid-container" class="shadow-lg">
                    <!-- Grid generated by JS -->
                </div>
            </div>

        </div> <!-- end flex-col/row -->
    </div> <!-- end main white panel -->

    <!-- Footer -->
    <footer class="text-center text-gray-600 text-sm mt-8 pb-4">
        by <a href="https://okuyuki.cc" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline">Okuyuki</a> for Cooler Master: FreeForm Playground Contest. <span class="ml-2 font-semibold">v1.9</span>
    </footer>

    <!-- 
      This script CANNOT be type="module".
      The three.js example scripts (OBJLoader, 3MFExporter) are not modules
      and rely on the global THREE object. This script must not be a module
      so it can access them.
    -->
    <script>
        // --- 1. CONFIGURATION AND INITIALIZATION ---

        const GRID_SIZE = 17;
        const OBJECT_DIM_MM = 20; // Dimensions of your 3D object (20x20x9.40mm)
        const OBJECT_HEIGHT_MM = 9.40;
        const SPACING_MM = 2; // Spacing between objects
        const TOTAL_CELL_DIM_MM = OBJECT_DIM_MM + SPACING_MM; 
        
        // Scale is now applied in the OBJLoader callback
        const OBJ_SCALE_X = 10.0;
        const OBJ_SCALE_Y = 10.0;
        const OBJ_SCALE_Z = 10.0; 


        const gridContainer = document.getElementById('grid-container');
        const colorPalette = document.getElementById('color-palette');
        const colorPicker = document.getElementById('color-picker');
        const clearBtn = document.getElementById('clear-btn');
        const downloadBtn = document.getElementById('download-btn');
        const statsTotalEl = document.getElementById('pixel-count-total');
        const statsColorsEl = document.getElementById('pixel-count-colors');
        
        let selectedColor = "null"; // "null" is the eraser
        let isMouseDown = false; 

        // 1D array to store the color of each grid cell
        let gridData = new Array(GRID_SIZE * GRID_SIZE).fill(null);
        
        // This will store the THREE.BufferGeometry
        let customGeometry = null;

        /**
         * Creates the pixel grid in the DOM
         */
        function createGrid() {
            gridContainer.innerHTML = ''; // Clear existing grid
            for (let i = 0; i < GRID_SIZE * GRID_SIZE; i++) {
                const pixel = document.createElement('div');
                pixel.classList.add('grid-pixel');
                pixel.dataset.index = i;

                const pixelInner = document.createElement('div');
                pixelInner.classList.add('pixel-inner');
                pixel.appendChild(pixelInner);
                
                // --- Paint Events ---
                pixel.addEventListener('mousedown', (e) => {
                    isMouseDown = true;
                    paintPixel(pixelInner, i);
                });
                
                pixel.addEventListener('mouseover', (e) => {
                    if (isMouseDown) {
                        paintPixel(pixelInner, i);
                    }
                });
                
                gridContainer.appendChild(pixel);
            }
        }
        
        // Stop painting if mouse leaves grid or is released anywhere
        window.addEventListener('mouseup', () => {
            isMouseDown = false;
        });
        gridContainer.addEventListener('mouseleave', () => {
            isMouseDown = false;
        });


        // --- 2. PAINTING AND STATE LOGIC ---

        /**
         * Paints a pixel in the DOM and updates the data
         */
        function paintPixel(pixelInnerElement, index) {
            const newColor = selectedColor === "null" ? null : selectedColor;
            
            // Only update if the color is different
            if (gridData[index] !== newColor) {
                gridData[index] = newColor;
                pixelInnerElement.style.backgroundColor = newColor || 'transparent';
                
                // Add/remove 'painted' class to show/hide the black dot
                if (newColor === null) {
                    pixelInnerElement.classList.remove('painted');
                } else {
                    pixelInnerElement.classList.add('painted');
                }
                updateStats();
            }
        }

        /**
         * Clears the grid and data
         */
        function clearGrid() {
            gridData.fill(null);
            const pixelsInner = gridContainer.querySelectorAll('.pixel-inner');
            pixelsInner.forEach(pixelInner => {
                pixelInner.style.backgroundColor = 'transparent';
                pixelInner.classList.remove('painted');
            });
            updateStats();
        }

        /**
         * Updates statistics (total count and count by color)
         */
        function updateStats() {
            const paintedPixels = gridData.filter(color => color !== null);
            const totalCount = paintedPixels.length;
            
            statsTotalEl.textContent = `Total: ${totalCount} pixels`;
            
            const colorCounts = {};
            paintedPixels.forEach(color => {
                colorCounts[color] = (colorCounts[color] || 0) + 1;
            });
            
            statsColorsEl.innerHTML = ''; // Clear previous stats
            const sortedColors = Object.keys(colorCounts).sort((a, b) => colorCounts[b] - colorCounts[a]);
            
            if (sortedColors.length === 0) {
                statsColorsEl.innerHTML = '<p class="text-gray-500">No pixels painted.</p>';
            } else {
                sortedColors.forEach(color => {
                    const count = colorCounts[color];
                    const row = document.createElement('div');
                    row.className = 'flex items-center justify-between';
                    row.innerHTML = `
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full border border-gray-300" style="background-color: ${color}"></div>
                            <span>${color}</span>
                        </div>
                        <span class="font-medium">${count}</span>
                    `;
                    statsColorsEl.appendChild(row);
                });
            }
        }

        // --- 3. COLOR PALETTE LOGIC ---

        /**
         * Sets the new active color
         * @param {string | null} newColor - The hex code or "null" for eraser
         * @param {HTMLElement | null} activeSwatch - The DOM element of the swatch clicked
         */
        function selectColor(newColor, activeSwatch) {
            selectedColor = newColor;
            
            // Remove 'active' class from all swatches
            colorPalette.querySelectorAll('.color-swatch').forEach(swatch => {
                swatch.classList.remove('active');
            });
            
            // Add 'active' class to the clicked swatch
            if (activeSwatch) {
                activeSwatch.classList.add('active');
            }
            
            // Update the color picker if a color (not eraser) was selected
            if (newColor !== 'null' && !activeSwatch) {
                // This means the color picker itself was used
                colorPicker.value = newColor;
            }
        }

        // Event listener for the palette
        colorPalette.addEventListener('click', (e) => {
            const swatch = e.target.closest('.color-swatch');
            if (swatch) {
                const color = swatch.dataset.color;
                selectColor(color, swatch);
            }
        });

        // Event listener for the custom color picker
        colorPicker.addEventListener('input', (e) => {
            selectColor(e.target.value, null);
        });

        // --- 4. .OBJ LOADING LOGIC (Using THREE.OBJLoader) ---

        /**
         * Loads the .obj model from the server
         */
        function loadCustomModel() {
            try {
                const objPath = 'assets/pixel.obj';
                // We construct an absolute URL to be safe
                const absoluteObjUrl = new URL(objPath, window.location.href).href;

                // Use THREE.OBJLoader (this should now be defined)
                const loader = new THREE.OBJLoader();
                loader.load(
                    // resource URL
                    absoluteObjUrl,
                    // onLoad callback
                    function ( group ) {
                        // The 'group' is a THREE.Group. We assume the first child
                        // is the mesh we want.
                        if (group.children.length > 0) {
                            customGeometry = group.children[0].geometry;
                            
                            // Apply the scale directly to the geometry
                            customGeometry.scale(OBJ_SCALE_X, OBJ_SCALE_Y, OBJ_SCALE_Z);
                            
                            // Enable the download button
                            downloadBtn.disabled = false;
                            downloadBtn.textContent = 'Download .3MF';
                            console.log('Custom model loaded and scaled successfully.');
                        } else {
                            throw new Error('OBJ file loaded but contains no geometry.');
                        }
                    },
                    // onProgress callback (optional)
                    function ( xhr ) {
                        console.log( ( xhr.loaded / xhr.total * 100 ) + '% loaded' );
                    },
                    // onError callback
                    function ( error ) {
                         throw new Error(`Error loading '${objPath}': ${error.message || 'Unknown error'}`);
                    }
                );

            } catch (error) {
                console.error(error);
                if (window.location.protocol === 'file:') {
                    alert(`Fatal Error: Could not load the 3D model.\n\nThis page is running from a local 'file://' address. Due to browser security, it cannot load the 'pixel.obj' file.\n\nTo fix this, please run it from a local web server (e.g., 'python -m http.server') or view it on GitHub Pages.`);
                } else {
                    alert(`Fatal Error: Could not load the 3D model. ${error.message}`);
                }
                downloadBtn.textContent = 'Error loading model';
            }
        }


        // --- 5. .3MF GENERATION LOGIC (Using THREE.3MFExporter) ---

        /**
         * Generates and triggers the download of the .3MF file
         */
        function generateAndDownload3MF() {
            
            // Check if the model is loaded
            if (!customGeometry) {
                alert("The custom 3D model has not loaded yet. Please wait a moment.");
                return;
            }

            console.log("Generating .3MF file (v1.9 - THREE.3MFExporter)...");

            // With r128, this constructor is correct
            const exporter = new THREE.ThreeMFExporter();
            const scene = new THREE.Scene();
            
            // Cache materials for performance
            const materialCache = {};

            const objectCenterOffset = OBJECT_DIM_MM / 2; // Assume the model is centered at 0,0

            gridData.forEach((color, index) => {
                if (color !== null) {
                    // Get or create material
                    if (!materialCache[color]) {
                        materialCache[color] = new THREE.MeshBasicMaterial({ 
                            color: new THREE.Color(color) 
                        });
                    }
                    const material = materialCache[color];

                    // Create a new mesh for this pixel
                    // We *must* use the same geometry and a different material
                    const mesh = new THREE.Mesh(customGeometry, material);

                    // Calculate 3D position
                    const x = (index % GRID_SIZE) * TOTAL_CELL_DIM_MM + objectCenterOffset;
                    // Invert Y-axis for 3D build (grid 0,0 is top-left, 3D 0,0 is bottom-left)
                    const y = (GRID_SIZE - 1 - Math.floor(index / GRID_SIZE)) * TOTAL_CELL_DIM_MM + objectCenterOffset; 
                    
                    mesh.position.set(x, y, 0);
                    
                    // Add to the scene
                    scene.add(mesh);
                }
            });

            // The exporter will process the scene and generate a 3MF file
            // that correctly lists multiple objects with different materials.
            exporter.parse(
                scene, 
                function ( arrayBuffer ) { // The result is an ArrayBuffer
                    
                    const blob = new Blob([arrayBuffer], { type: 'application/zip' });
                    
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = "pixelmyqube_custom.3mf";
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    console.log(".3MF file generated and downloaded!");

                },
                function ( error ) {
                    console.error("Error generating the .3mf file:", error);
                    alert("An error occurred while generating the .3mf file. Check the console for more details.");
                }
            );
        }


        // --- 6. APP INITIALIZATION ---
        
        clearBtn.addEventListener('click', clearGrid);
        downloadBtn.addEventListener('click', generateAndDownload3MF);

        createGrid();
        updateStats();
        selectColor('null', document.querySelector('.color-swatch[data-color="null"]'));
        
        // Start loading the .OBJ model as soon as the page runs
        loadCustomModel();

    </script>
</body>
</html>
